<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stripe Payment Demo</title>
  <link rel="stylesheet" th:href="@{/css/common.css}" />
  <link rel="stylesheet" th:href="@{/css/payment/payment.css}" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>

  </style>
</head>
<body>
  	<div class="content">
  		<div class="item-information">
  			<div class="field bold">
	  			<label>ITEM INFORMATION</label>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>ITEM NAME</label>
  				<div>POSITION</div>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>QUANTITY</label>
  				<div>POSITION</div>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>DATE TO BORROW</label>
  				<div>POSITION</div>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>DATE TO NUMBER</label>
  				<div>POSITION</div>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>PRICE</label>
  				<div>POSITION</div>
  			</div>
  			<hr class="soft-gradient">
  			<div class="field">
  				<label>TOTAL AMOUNT</label>
  				<div>POSITION</div>
  			</div>
  		</div>
  		
  		<div class="payment-information">
  			<div class="item-information">
	  			<div class="field bold">
		  			<label>PAYMENT</label>
	  			</div>
	  			<hr class="soft-gradient">
	  			
	  			<!-- Stripe Payment Section -->
	  			<div class="payment-field">
	  				<label>Choose Payment Method</label>
	  				<div id="methods">
					  <label>
					    <input type="radio" name="method" value="card" checked> Card
					  </label>
					  <label>
					    <input type="radio" name="method" value="link"> Link
					  </label>
					  <!-- If you later want GCash/GrabPay, just add more radios here -->
					</div>
	
	  			</div>
	  			<hr class="soft-gradient">
	  			
	  			<div class="payment-field">
	  				<label>Card Details</label>
	  				<div id="card-element"></div>
	  				<span class="error" id="card-errors"></span>
	  			</div>
  			</div>
  			<div class="btns">
  				<a class="button" th:href="@{/dashboard}">CANCEL</a>
  				<button id="pay-btn">CONFIRM PAYMENT</button>
  			</div>
  		</div>
  	</div>

  <script th:inline="javascript">
  const publicKey = /*[[${publicKey}]]*/'';
  const stripe = Stripe(publicKey);
  const elements = stripe.elements();
  const cardElement = elements.create("card");

  const payBtn = document.getElementById("pay-btn");
  const errorDiv = document.getElementById("card-errors");
  const cardDiv = document.getElementById("card-element");

  let clientSecret;

  // 1. Fetch PaymentIntent from backend
  fetch("/api/payment/create-intent?amount=5000")
    .then(res => res.json())
    .then(data => {
      clientSecret = data.clientSecret;

      // Mount card element
      cardElement.mount("#card-element");

      // Toggle card input visibility
      document.querySelectorAll("input[name='method']").forEach(radio => {
        radio.addEventListener("change", e => {
          if (e.target.value === "card") {
            cardDiv.style.display = "block";
          } else {
            cardDiv.style.display = "none";
          }
        });
      });

      cardDiv.style.display = "block"; // default visible
    });

  // 2. Payment button click
  payBtn.addEventListener("click", async () => {
    payBtn.disabled = true;
    payBtn.textContent = "Processing...";

    const method = document.querySelector("input[name='method']:checked").value;
    let result;

    if (method === "card") {
      // Card payment
      result = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: cardElement,
          billing_details: { email: "julius.basas0123@gmail.com" }
        },
        receipt_email: "julius.basas0123@gmail.com"
      });
    } else if (method === "link") {
      // Link payment
      result = await stripe.confirmPayment({
        elements,
        clientSecret,
        confirmParams: {
          return_url: "http://localhost:8080/payment/success",
        },
      });
    }

    // 3. Handle result
    if (result.error) {
      errorDiv.textContent = result.error.message;
      payBtn.disabled = false;
      payBtn.textContent = "CONFIRM PAYMENT";
    } else if (result.paymentIntent && result.paymentIntent.status === "succeeded") {
      alert("Payment successful!");
      payBtn.textContent = "Paid âœ…";
      if (result.paymentIntent.charges?.data?.[0]?.receipt_url) {
        window.location.href = result.paymentIntent.charges.data[0].receipt_url;
      }
    }
  });
  </script>



</body>
</html>
