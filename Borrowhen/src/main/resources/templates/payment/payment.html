<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
      <meta name="robots" content="noindex, nofollow" />
      <meta name="_csrf" th:content="${_csrf.token}"/>
  	  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
      <title>Borrowhen | Payment</title>
      <!-- Favicon -->
      <link rel="icon" type="image/x-icon" th:href="@{/assets/logo.ico}" />
      <!-- Fonts -->
      <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
      <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300..900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300..800&display=swap" rel="stylesheet">
      <!-- Icons -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
      <!-- CSS -->
      <link rel="stylesheet" th:href="@{/css/style.css}" />
      <link rel="stylesheet" th:href="@{/css/output.css}" />
      <script src="https://js.stripe.com/v3/"></script>
   </head>
   <body class="bg-base-200" th:object="${borrowRequestDto}">
      <div class="min-h-screen flex flex-col">
         <!-- HEADER -->
         <div th:replace="~{header :: header-borrower}"></div>
         <main class="flex-1 flex flex-col md:flex-row relative font-['Inter']">
            <!-- LEFT SECTION: Original Payment Summary -->
            <div class="bg-blue-600 text-white md:w-1/2 w-full p-10 flex flex-col justify-center">
               <div class="max-w-md mx-auto bg-blue-700/40 backdrop-blur-sm p-8 rounded-2xl shadow-xl border border-blue-400/30">
                  <!-- Header -->
                  <div class="flex items-center justify-between mb-6">
                     <h2 class="text-2xl font-semibold text-white flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-blue-200"></i> Payment Summary
                     </h2>
                     <span class="text-xs bg-blue-500/60 px-3 py-1 rounded-full text-white font-medium tracking-wide">
                     #Order-{{orderId}}
                     </span>
                  </div>
                  <p class="text-blue-100 mb-6 text-sm leading-relaxed">
                     Review your borrowing details before confirming your payment below.
                  </p>
                  <!-- Summary Card -->
                  <div class="bg-blue-800/40 rounded-xl border border-blue-400/20 p-4 shadow-inner space-y-3 text-sm">
                     <div class="flex justify-between items-center">
                        <span class="text-blue-100">Item Name</span>
                        <span class="font-semibold text-white" th:text="*{request.itemName}">Laptop</span>
                     </div>
                     <div class="flex justify-between items-center">
                        <span class="text-blue-100">Quantity</span>
                        <span class="font-semibold text-white" th:text="*{request.qty}">1</span>
                     </div>
                     <div class="flex justify-between items-center">
                        <span class="text-blue-100">Date to Borrow</span>
                        <span class="font-semibold text-white" th:text="*{request.dateToBorrow}">2025-10-12</span>
                     </div>
                     <div class="flex justify-between items-center">
                        <span class="text-blue-100">Date to Return</span>
                        <span class="font-semibold text-white" th:text="*{request.dateToReturn}">2025-10-15</span>
                     </div>
                     <div class="flex justify-between items-center border-t border-blue-400/30 pt-3 mt-2">
                        <span class="text-blue-100">Price</span>
                        <span class="font-semibold text-white" th:text="*{request.price}">₱500</span>
                     </div>
                     <div class="flex justify-between items-center border-t border-blue-300/40 pt-4 mt-3">
                        <span class="font-semibold text-white text-lg">Total</span>
                        <span class="font-bold text-white text-lg" th:text="*{@calculationUtil.getTotalPrice(request.qty, request.price)}">₱500</span>
                     </div>
                  </div>
                  <!-- Footer Note -->
                  <div class="mt-6 flex items-center gap-2 text-xs text-blue-200/90">
                     <i class="fa-solid fa-info-circle"></i>
                     <p>Ensure all details are correct before confirming your payment.</p>
                  </div>
               </div>
            </div>
            <!-- RIGHT SECTION: Modern Confirm Payment -->
            <div class="bg-gray-50 md:w-1/2 w-full flex items-center justify-center p-10">
               <div id="payment-container" class="bg-white shadow-xl border border-gray-100 rounded-2xl p-8 max-w-md w-full">
                  <h3 class="text-2xl font-semibold text-gray-800 mb-2 flex items-center gap-2">
                     <i class="fa-solid fa-wallet text-blue-600"></i>
                     Confirm Your Payment
                  </h3>
                  <p class="text-gray-500 mb-6 text-sm">Securely pay using your preferred method below.</p>
                  <!-- Payment Method -->
                  <div class="flex gap-6 mb-6">
                     <label class="flex items-center gap-2 cursor-pointer">
                     <input type="radio" name="method" value="card" checked class="accent-blue-600">
                     <span class="text-gray-700">Card</span>
                     </label>
                     <label class="flex items-center gap-2 cursor-pointer">
                     <input type="radio" name="method" value="link" class="accent-blue-600">
                     <span class="text-gray-700">Link</span>
                     </label>
                  </div>
                  <!-- Card Input -->
                  <div class="mb-6">
                     <label class="block text-sm font-medium text-gray-700 mb-2">Card Details</label>
                     <div id="card-element" class="border border-gray-300 rounded-lg p-3 bg-gray-50 shadow-inner"></div>
                     <span id="card-errors" class="error text-red-500 text-sm mt-2 block"></span>
                  </div>
                  <!-- Buttons -->
                  <div class="flex justify-end gap-4">
                     <a th:href="@{/dashboard}" class="px-5 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition duration-200">
                     Cancel
                     </a>
                     <button id="pay-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 active:scale-95 shadow-md transition-all duration-200">
                     Confirm Payment
                     </button>
                  </div>
                  <!-- Small note -->
                  <p class="text-xs text-gray-400 text-center mt-6">
                     <i class="fa-solid fa-lock mr-1"></i> Your payment information is encrypted and secure.
                  </p>
               </div>
            </div>
         </main>
      </div>
      <script th:src="@{/script/loading.js}"></script>
      <!-- Stripe Payment Script -->
      <script th:inline="javascript">
         const publicKey = /*[[${publicKey}]]*/ '';
         const clientSecret = /*[[${paymentDto.clientSecret}]]*/ '';
         const encryptedRequestId = /*[[${borrowRequestDto.encryptedId}]]*/ '';
         const stripe = Stripe(publicKey);
         const elements = stripe.elements();
         const cardElement = elements.create("card");
         cardElement.mount("#card-element");
         
         const payBtn = document.getElementById("pay-btn");
         const paymentContainer = document.querySelector('#payment-container');
         const errorDiv = document.getElementById("card-errors");
         
         payBtn.addEventListener("click", async () => {
           payBtn.disabled = true;
           payBtn.textContent = "Processing...";
           
           createLoadingScreenBody();
         
           const method = document.querySelector("input[name='method']:checked").value;
           let result;
         
           if (method === "card") {
             result = await stripe.confirmCardPayment(clientSecret, {
               payment_method: {
                 card: cardElement,
                 billing_details: { email: /*[[${paymentDto.emailAddress}]]*/ '' }
               },
               receipt_email: /*[[${paymentDto.emailAddress}]]*/ ''
             });
           } else if (method === "link") {
             result = await stripe.confirmPayment({
               elements,
               clientSecret,
               confirmParams: { return_url: "http://localhost:8080/payment/success" },
             });
           }
         
           if (result.error) {
             errorDiv.textContent = result.error.message;
             payBtn.disabled = false;
             payBtn.textContent = "Confirm Payment";
           } else if (result.paymentIntent && result.paymentIntent.status === "succeeded") {
             
             removeLoadingScreenBody();
             
             paymentContainer.innerHTML = `
            	  <div class="flex flex-col items-center w-full text-center space-y-3 mt-2">
            	    <div class="flex items-center gap-2 text-green-600 font-semibold text-base">
            	      <i class="fa-solid fa-circle-check text-green-600 text-lg"></i>
            	      <span>Payment Successful!</span>
            	    </div>
            	    <p class="text-gray-500 text-sm">
            	      Thank you for your payment. You can now return to your dashboard.
            	    </p>
            	    <a href="/dashboard?feedback=${encryptedRequestId}"
            	       class="inline-flex items-center justify-center px-6 py-2 bg-green-600 text-blue-500 rounded-lg font-semibold hover:bg-green-700 active:scale-95 shadow-md transition-all duration-200">
            	       <i class="fa-solid fa-arrow-left mr-2"></i> Back to Dashboard
            	    </a>
            	  </div>
            	`;
         
             const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
             const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
         
             fetch("/api/payment/confirmed", {
               method: "POST",
               headers: { "Content-Type": "application/x-www-form-urlencoded", [csrfHeader]: csrfToken },
               body: new URLSearchParams({
                 encryptedId: encryptedRequestId
               })
             })
             .catch(err => {
               console.error("Error confirming payment:", err);
               alert("Payment succeeded but failed to notify server!");
             });
         
             if (result.paymentIntent.charges?.data?.[0]?.receipt_url) {
               window.open(result.paymentIntent.charges.data[0].receipt_url, "_blank");
             }
           }
         });
      </script>
   </body>
</html>