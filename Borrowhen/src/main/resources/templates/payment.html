<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stripe Payment Demo</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    #card-element {
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <h2>Stripe Payment Example</h2>

  <!-- Card input field -->
  <div id="card-element"></div>
  <div id="card-errors" style="color:red;"></div>

  <!-- One single pay button -->
  <button id="pay-btn">Pay ₱50.00</button>

  <script>
    // ✅ Initialize Stripe
    const stripe = Stripe("21312");
    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const payBtn = document.getElementById("pay-btn");
    const errorDiv = document.getElementById("card-errors");

    // Show validation errors
    cardElement.on("change", (ev) => {
      errorDiv.textContent = ev.error ? ev.error.message : "";
      payBtn.disabled = !ev.complete;
    });

    payBtn.addEventListener("click", async () => {
      payBtn.disabled = true;
      payBtn.textContent = "Processing...";

      // Call backend to create PaymentIntent
      const res = await fetch("/api/payment/create-intent?amount=5000", { method: "GET" });
      const data = await res.json();

      const result = await stripe.confirmCardPayment(data.clientSecret, {
        payment_method: {
          card: cardElement,
          billing_details: { email: "julius.basas0123@gmail.com" }
        },
      receipt_email: "julius.basas0123@gmail.com"
      });

      if (result.error) {
        errorDiv.textContent = result.error.message;
        payBtn.disabled = false;
        payBtn.textContent = "Pay ₱50.00";
      } else if (result.paymentIntent.status === 'succeeded') {
        alert("Payment successful!");
        payBtn.textContent = "Paid ✅";
        const res = await fetch(`/api/payment/receipt?paymentIntentId=${result.paymentIntent.id}`);
        const data = await res.json();
        window.location.href = data.receiptUrl; // redirect user to Stripe-hosted receipt
      }
    });
  </script>
</body>
</html>
